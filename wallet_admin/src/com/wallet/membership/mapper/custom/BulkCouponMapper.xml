<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.BulkCouponMapper" >
  <resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.BulkCoupon" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    <result column="CPN_ID" property="CpnID" jdbcType="VARCHAR" />
    <result column="PART" property="Part" jdbcType="VARCHAR" />
    <result column="NAME" property="Name" jdbcType="VARCHAR" />
    <result column="sort_v" property="SortV" jdbcType="CHAR" />
    <result column="TOT_CNT" property="TotCnt" jdbcType="VARCHAR" />
    <result column="ISSUE_CNT" property="IssueCnt" jdbcType="VARCHAR" />
    <result column="CPN_ISSUE_STAT" property="CpnIssueStat" jdbcType="VARCHAR" />
    <result column="REG_DTM" property="RegDtm" jdbcType="VARCHAR" />
    <result column="val_eday" property="ValEndDay" jdbcType="VARCHAR" />
    <result column="val_sday" property="ValStartDay" jdbcType="VARCHAR" />
    <result column="sday" property="StartDay" jdbcType="VARCHAR" />
    <result column="eday" property="EndDay" jdbcType="VARCHAR" />
    <result column="name" property="CpnName" jdbcType="VARCHAR" />
    <result column="user_id" property="UserID" jdbcType="VARCHAR" />
    <result column="auth_name" property="AuthName" jdbcType="VARCHAR" />
    <result column="barcode" property="Barcode" jdbcType="VARCHAR" />
    <result column="reg_day" property="RegDay" jdbcType="VARCHAR" />
    <result column="memb_id" property="membId" jdbcType="VARCHAR" />
    <result column="REG_USER" property="RegUser" jdbcType="VARCHAR" />
    <result column="CHG_DTM" property="ChgDtm" jdbcType="TIMESTAMP" />
    <result column="CHG_USER" property="ChgUser" jdbcType="VARCHAR" />
<!-- 
    <result column="name" property="membName" jdbcType="VARCHAR" />
 -->
    <result column="BULKYN" property="bulkYn"  jdbcType="VARCHAR" />
    
    <result column="REG_DTM_STR" property="regDtmStr" jdbcType="VARCHAR" />
    <result column="CHG_DTM_STR" property="chgDtmStr" jdbcType="VARCHAR" />
    
    <result column="PARTNER_NAME" property="partnerName" jdbcType="VARCHAR" />
    <result column="BRAND_NAME" property="brandName" jdbcType="VARCHAR" />
    <result column="COMP_NAME" property="compName" jdbcType="VARCHAR" />

  </resultMap>

  <select id="selectByMemberExample" resultMap="BaseResultMap" parameterType="com.wallet.membership.model.custom.BulkCoupon" >      
	SELECT memb_id, name FROM memb_cardlist
	</select>
  
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.wallet.membership.model.custom.BulkCoupon" >      
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    SELECT     
    <if test="rowsPerPage != 0">
			top ${rowsPerPage}
		</if>
 	 A.CPN_ID
     , CASE WHEN C.part_v='M' THEN '멤버십 쿠폰'
	        WHEN C.part_v='P' THEN '프릭스 쿠폰'
	        WHEN C.part_v='R' THEN '해외 쿠폰'
	        WHEN C.part_v='U' THEN '유비페이 쿠폰'
	        ELSE '일반/이벤트 쿠폰'
	   END AS PART
     , C.NAME
     , D.name
     , C.sort_v
     , ISNULL(B.TOT_CNT,0) AS TOT_CNT
     , ISNULL(B.ISSUE_CNT,0) AS ISSUE_CNT
     , A.REG_DTM
     , A.REG_USER
     , (SELECT REG_DTM FROM MW_CS_BULK_CPN E WHERE A.CPN_ID = E.CPN_ID AND ISSUE_SEQ = 1) AS CHG_DTM
     , (SELECT REG_USER FROM MW_CS_BULK_CPN E WHERE A.CPN_ID = E.CPN_ID AND ISSUE_SEQ = 1) AS CHG_USER
     , A.BAR_ISSUE_TYPE
     , A.CPN_STAT
     , C.val_eday
     , C.val_sday
     , C.sday
     , C.eday
     , (SELECT COMP_NAME FROM MW_CM_COMPANY F WHERE A.COMP_ID = F.COMP_ID) AS PARTNER_NAME
     , (SELECT COMP_NAME FROM MW_CM_COMPANY G WHERE A.BRAN_ID = G.COMP_ID) AS BRAND_NAME
     ,(CONVERT(CHAR(10), A.REG_DTM, 23)) AS REG_DTM_STR
     ,(CONVERT(CHAR(10), (SELECT REG_DTM FROM MW_CS_BULK_CPN E WHERE A.CPN_ID = E.CPN_ID AND ISSUE_SEQ = 1), 23)) AS CHG_DTM_STR
     , CASE WHEN A.CPN_ISSUE_STAT='01' THEN '발행'
            WHEN A.CPN_ISSUE_STAT='02' THEN '중단'
            WHEN A.CPN_ISSUE_STAT='03' THEN '종료'
       END AS CPN_ISSUE_STAT
	  ,(CASE WHEN (SELECT COUNT(*) FROM MW_CS_BULK_CPN E WHERE E.CPN_ID=B.CPN_ID)=0 
        THEN 'N' 
        ELSE 'Y'
	    END) AS BULKYN
		
		FROM MW_CS_CPN_LIST A
		FULL JOIN (
		SELECT CPN_ID
			 , COUNT(*) AS TOT_CNT
			 , (SELECT COUNT(*)FROM cpn_gen_his H WHERE H.cpn_id = R.CPN_ID) AS ISSUE_CNT
		  FROM MW_CS_BULK_CPN R
		 GROUP BY CPN_ID
	   ) B ON A.CPN_ID = B.CPN_ID
	   INNER JOIN cpn_list C ON A.CPN_ID = C.cpn_id
	   FULL JOIN memb_cardlist D ON C.memb_id = D.memb_id

	   WHERE A.BAR_ISSUE_TYPE = '04'
				
	<if test="cuponPart != null">
		AND C.part_v = '${cuponPart}'
		</if> 
		<if test="membId != null">
		AND C.memb_id='${membId}'
		</if>
		<if test="partnerName != null">
		AND (SELECT COMP_NAME FROM MW_CM_COMPANY F WHERE A.COMP_ID = F.COMP_ID) LIKE '%${partnerName}%'
		</if>
		<if test="shStartDays != null "> 
		    <if test="shEndDays != null">
		AND (A.REG_DTM BETWEEN '${shStartDays}' AND '${shEndDays}')
			</if>
		</if>
		<if test="coponName != null"> 		    
		AND C.NAME LIKE '%${coponName}%'
		</if>
		<if test="CpnID != null"> 		    
		AND A.CPN_ID = '${CpnID}'
		</if>
	order by A.REG_DTM DESC , C.NAME DESC 	
  </select>

  <select id="popupByExample" resultMap="BaseResultMap" parameterType="com.wallet.membership.model.custom.BulkCoupon" >      
   <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    <!-- 
    /*
    SELECT
			top ${rowsPerPage}
     A.user_id
     ,A.auth_name
     ,B.barcode
     ,B.reg_day
     ,C.NAME
    , CASE WHEN C.part_v='M' THEN '멤버십 쿠폰'
	        WHEN C.part_v='P' THEN '프릭스 쿠폰'
	        WHEN C.part_v='R' THEN '해외 쿠폰'
	        WHEN C.part_v='U' THEN '유비페이 쿠폰'
	        ELSE '일반/이벤트 쿠폰'
	   END AS PART
     ,D.name
    FROM user_desc A 
	INNER JOIN my_cpn B ON A.user_id = B.user_id
	INNER JOIN cpn_list C ON B.cpn_id = C.cpn_id
	INNER JOIN memb_cardlist D ON C.memb_id = D.memb_id
	WHERE C.cpn_id = '${CpnID}' */
	 -->
	SELECT 
		<if test="rowsPerPage != 0">
			TOP ${rowsPerPage}
		</if>
		 A.user_id, A.auth_name, B.barcode, B.reg_day, C.NAME 
	, CASE WHEN C.PART_V='M' THEN '멤버십 쿠폰'
		WHEN C.PART_V='P' THEN '프릭스 쿠폰' 
		WHEN C.PART_V='R' THEN '해외 쿠폰' 
		WHEN C.PART_V='U' THEN '유비페이 쿠폰' 
		ELSE '일반/이벤트 쿠폰' END 
	AS PART 
	/*, D.NAME*/ 
	, E.COMP_NAME
	FROM USER_DESC A 
	INNER JOIN MY_CPN B 
		ON A.USER_ID = B.USER_ID 
	INNER JOIN (SELECT S.*, T.COMP_ID FROM CPN_LIST S, MW_CS_CPN_LIST T WHERE S.CPN_ID = T.CPN_ID) AS  C 
		ON B.CPN_ID = C.CPN_ID 
	INNER JOIN MEMB_CARDLIST D 
		ON C.MEMB_ID = D.MEMB_ID
	INNER JOIN MW_CM_COMPANY E
		ON E.COMP_ID = C.COMP_ID
	WHERE C.CPN_ID = '${CpnID}'

	
    </select>
 
  <select id="countByExample" resultType="java.lang.Integer"  parameterType="com.wallet.membership.model.custom.BulkCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    SELECT count(*)  
  FROM MW_CS_CPN_LIST A
		FULL JOIN (
		SELECT CPN_ID
			 , COUNT(*) AS TOT_CNT
			 , (SELECT COUNT(*)FROM cpn_gen_his H WHERE H.cpn_id = R.CPN_ID) AS ISSUE_CNT
		  FROM MW_CS_BULK_CPN R
		 GROUP BY CPN_ID
	   ) B ON A.CPN_ID = B.CPN_ID
	   INNER JOIN cpn_list C ON A.CPN_ID = C.cpn_id
	   FULL JOIN memb_cardlist D ON C.memb_id = D.memb_id
	   WHERE A.BAR_ISSUE_TYPE = '04'
	
	<if test="cuponPart != null">
		AND C.part_v = '${cuponPart}'
		</if> 
		<if test="membId != null">
		AND C.memb_id='${membId}'
		</if>
		<if test="shStartDays != null "> 
		    <if test="shEndDays != null">
		AND (A.REG_DTM BETWEEN '${shStartDays}' AND '${shEndDays}')
			</if>
		</if>
		<if test="coponName != null"> 		    
		AND C.NAME LIKE '%${coponName}%'
		</if>
		<if test="partnerName != null">
		AND (SELECT COMP_NAME FROM MW_CM_COMPANY F WHERE A.COMP_ID = F.COMP_ID) LIKE '%${partnerName}%'
		</if>
		</select>		
		
  <select id="PopupcountByExample" resultType="java.lang.Integer"  parameterType="com.wallet.membership.model.custom.BulkCoupon">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    SELECT count(*)  
     FROM user_desc A 
		INNER JOIN my_cpn B ON A.user_id = B.user_id
		INNER JOIN cpn_list C ON B.cpn_id = C.cpn_id
		WHERE C.cpn_id = '${CpnID}'
    </select>

   <update id="updateByMwCsCpnlistSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 10:02:55 KST 2012.
    -->
         
        update MW_CS_CPN_LIST SET
        <if test="CpnIssueStat != null" > 	        
         CPN_ISSUE_STAT = #{CpnIssueStat,jdbcType=VARCHAR},
        </if>
        <if test="ChgDtm != null" > 
         CHG_DTM = #{ChgDtm,jdbcType=TIMESTAMP},
        </if>
        <if test="ChgUser != null" > 
         CHG_USER = #{ChgUser,jdbcType=VARCHAR}
        </if> 
          where CPN_ID = #{CpnID,jdbcType=VARCHAR}	    	
      
      
    
  </update>
  
   <update id="updateByMwCsBulkCpnSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 10:02:55 KST 2012.
    -->   
       <if test="IssueCnt != null" >   
        update MW_CS_BULK_CPN    
        SET ISSUE_CNT = #{IssueCnt,jdbcType=VARCHAR}
        where CPN_ID = #{CpnID,jdbcType=VARCHAR}        
      </if>       
      
  </update>
  
   <update id="updateByCpnlistSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 29 10:02:55 KST 2012.
    -->
    <!-- 
    update cpn_list
    <set>

      <if test="ValEndDay != null" >
        val_eday = #{ValEndDay,jdbcType=VARCHAR},
      </if>   
      <if test="ValStartDay != null" >
        val_sday = #{ValStartDay,jdbcType=VARCHAR},
      </if>   

       <if test="StartDay != null" >
        sday = #{StartDay,jdbcType=VARCHAR},
      </if>   
      <if test="EndDay != null" >
        eday = #{EndDay,jdbcType=VARCHAR},
      </if>  
 
    </set>
    where CPN_ID = #{CpnID,jdbcType=VARCHAR}
     -->
  </update>
  
   <delete id="deleteByMwCsCpnlistSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon">
       delete MW_CS_CPN_LIST where CPN_ID = #{CpnID,jdbcType=VARCHAR}
   </delete>
   
   <delete id="deleteByMwCsBulkCpnSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon">
       delete MW_CS_BULK_CPN where CPN_ID = #{CpnID,jdbcType=VARCHAR}
   </delete>
   
   <delete id="deleteByCpnlistSelective" parameterType="com.wallet.membership.model.custom.BulkCoupon">
       delete cpn_list where CPN_ID = #{CpnID,jdbcType=VARCHAR}
   </delete>
  
</mapper>