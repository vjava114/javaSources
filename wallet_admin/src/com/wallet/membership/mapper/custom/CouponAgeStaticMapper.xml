<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.CouponAgeStaticMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.CouponAgeStatic" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="CPN_ID" property="cpnId" jdbcType="VARCHAR" />
		<result column="STAT_DAY" property="statDay" jdbcType="VARCHAR" />
		<result column="AGE00_M_CNT" property="age00MCnt" jdbcType="VARCHAR" />
		<result column="AGE00_F_CNT" property="age00FCnt" jdbcType="VARCHAR" />
		<result column="AGE10_M_CNT" property="age10MCnt" jdbcType="VARCHAR" />
		<result column="AGE10_F_CNT" property="age10FCnt" jdbcType="VARCHAR" />
		<result column="AGE20_M_CNT" property="age20MCnt" jdbcType="VARCHAR" />
		<result column="AGE20_F_CNT" property="age20FCnt" jdbcType="VARCHAR" />
		<result column="AGE30_M_CNT" property="age30MCnt" jdbcType="VARCHAR" />
		<result column="AGE30_F_CNT" property="age30FCnt" jdbcType="VARCHAR" />
		<result column="AGE40_M_CNT" property="age40MCnt" jdbcType="VARCHAR" />
		<result column="AGE40_F_CNT" property="age40FCnt" jdbcType="VARCHAR" />
		<result column="AGE50_M_CNT" property="age50MCnt" jdbcType="VARCHAR" />
		<result column="AGE50_F_CNT" property="age50FCnt" jdbcType="VARCHAR" />
		<result column="AGE60_M_CNT" property="age60MCnt" jdbcType="VARCHAR" />
		<result column="AGE60_F_CNT" property="age60FCnt" jdbcType="VARCHAR" />
		<result column="M_CNT" property="mCnt" jdbcType="VARCHAR" />
		<result column="F_CNT" property="fCnt" jdbcType="VARCHAR" />
		<result column="TOT_CNT" property="totCnt" jdbcType="VARCHAR" />
		<result column="PART_V_NM" property="partVNm" jdbcType="VARCHAR" />
		<result column="PART_V" property="partV" jdbcType="VARCHAR" />
		<result column="NAME" property="name" jdbcType="VARCHAR" />
		<result column="COMP_NAME" property="compName" jdbcType="VARCHAR" />
		
	</resultMap>

	<!-- 조회조건에 대한 멤버십 목록 -->
	<select id="selectCouponAgeStaticDayList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT
	 			  A.STAT_DAY
	 			, B.PART_V 
				, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
				, C.COMP_ID -- 제휴사
				, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
				, A.CPN_ID
				, B.NAME
				, SUM(AGE00_M_CNT) AS AGE00_M_CNT
				, SUM(AGE00_F_CNT) AS AGE00_F_CNT
				, SUM(AGE10_M_CNT) AS AGE10_M_CNT
				, SUM(AGE10_F_CNT) AS AGE10_F_CNT
				, SUM(AGE20_M_CNT) AS AGE20_M_CNT
				, SUM(AGE20_F_CNT) AS AGE20_F_CNT
				, SUM(AGE30_M_CNT) AS AGE30_M_CNT
				, SUM(AGE30_F_CNT) AS AGE30_F_CNT
				, SUM(AGE40_M_CNT) AS AGE40_M_CNT
				, SUM(AGE40_F_CNT) AS AGE40_F_CNT
				, SUM(AGE50_M_CNT) AS AGE50_M_CNT
				, SUM(AGE50_F_CNT) AS AGE50_F_CNT
				, SUM(AGE60_M_CNT) AS AGE60_M_CNT
				, SUM(AGE60_F_CNT) AS AGE60_F_CNT
				, SUM( AGE00_M_CNT + AGE10_M_CNT + AGE20_M_CNT + AGE30_M_CNT + AGE40_M_CNT + AGE50_M_CNT + AGE60_M_CNT ) AS M_CNT
				, SUM( AGE00_F_CNT + AGE10_F_CNT + AGE20_F_CNT + AGE30_F_CNT + AGE40_F_CNT + AGE50_F_CNT + AGE60_F_CNT ) AS F_CNT
				, SUM(AGE00_M_CNT + AGE10_M_CNT + AGE20_M_CNT + AGE30_M_CNT + AGE40_M_CNT + AGE50_M_CNT + AGE60_M_CNT+
					AGE00_F_CNT + AGE10_F_CNT + AGE20_F_CNT + AGE30_F_CNT + AGE40_F_CNT + AGE50_F_CNT + AGE60_F_CNT) AS TOT_CNT
		FROM MW_CS_CPN_DAY_STAT_AGE_SEX A
		       INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
		       INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
		       LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
			<if test='sdate!=null and sdate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) >=	REPLACE(#{sdate}, '-', '')
					]]>
				</if>
			</if>
			<if test='edate!=null and edate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) <=	REPLACE(#{edate}, '-', '')
					]]>
				</if>
			</if>
		</if>
		<if test='partV!=null and partV!=""'>
			AND B.part_v = #{partV}
		</if>
		<if test='name!=null and name!=""'>
			AND B.name LIKE '%${name}%'
		</if>
		<if test='compName!=null and compName!=""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		GROUP BY
			  A.STAT_DAY
			, B.PART_V
			, C.COMP_ID 
			, A.CPN_ID
			, B.NAME
	</select>
	
	<resultMap type="hashMap" id="dataMap">
		<result property="contents" column="contents" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectCouponAgeStaticMonthList" parameterType="map" resultMap="dataMap">
		SELECT 
			  B.PART_V /*-- 쿠폰구분*/
			, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
			, C.COMP_ID /*-- 제휴사*/
			, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
			, A.CPN_ID
			, B.NAME
			, AGE_TYPE   /*-- OS구분 ( 00:10대미만,10:10대,20:20대,30:30대,40:40대,50:50대,60:60대이상 )*/
			, SEX_TYPE   /*-- 통신사구분 ( 01:남자, 02:여자 )*/
			/*
			, SUM(CASE WHEN STAT_MONTH = '201209' THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT1 -- 기간만큼 필요
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+1,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT2
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+2,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT3
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+3,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT4
			, SUM(ISNULL(USER_CNT,0)) AS SUM_CNT -- 합계
			*/
			${subQuery}
		FROM  MW_CS_CPN_MONTH_STAT_AGE_SEX A
			INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
			INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
			LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='partV != null and partV != ""'>
			AND B.PART_V  = #{partV} /*쿠폰구분*/
		</if>
		<if test='compName != null and compName != ""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		<if test='name != null and name != ""'>
			AND B.NAME LIKE '%${name}%' /*쿠폰명*/
		</if>
		
		<if test='sdate != null and sdate != ""'>
			<![CDATA[
			AND A.STAT_MONTH  >= LEFT(REPLACE(#{sdate}, '-', ''), 6)
			]]>
		</if>
		<if test='edate != null and edate != ""'>
			<![CDATA[
			AND A.STAT_MONTH  <= LEFT(REPLACE(#{edate}, '-', ''), 6)
			]]>
		</if>
		GROUP BY 
			B.PART_V /*쿠폰구분*/
			, C.COMP_ID /*제휴사*/
			, A.CPN_ID
			, B.NAME
			, AGE_TYPE
			, SEX_TYPE
		ORDER BY 
			B.PART_V /*쿠폰구분*/
			, C.COMP_ID /*제휴사*/
			, A.CPN_ID
			, B.NAME
			, AGE_TYPE
			, SEX_TYPE
	</select>
	
</mapper>