<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.CouponOsStaticMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.CouponOsStatic" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="CPN_ID" property="cpnId" jdbcType="VARCHAR" />
		<result column="STAT_DAY" property="statDay" jdbcType="VARCHAR" />
		<result column="ANDROID_KT_CNT" property="androidKtCnt" jdbcType="VARCHAR" />
		<result column="ANDROID_SKT_CNT" property="androidSktCnt" jdbcType="VARCHAR" />
		<result column="ANDROID_LGU_CNT" property="androidLguCnt" jdbcType="VARCHAR" />
		<result column="IPHONE_KT_CNT" property="iphoneKtCnt" jdbcType="VARCHAR" />
		<result column="IPHONE_SKT_CNT" property="iphoneSktCnt" jdbcType="VARCHAR" />
		<result column="IPHONE_LGU_CNT" property="iphoneLguCnt" jdbcType="VARCHAR" />
		<result column="PART_V" property="partV" jdbcType="VARCHAR" />
		<result column="NAME" property="name" jdbcType="VARCHAR" />
		<result column="COMP_NAME" property="compName" jdbcType="VARCHAR" />
		<result column="ANDROID_CNT" property="androidCnt" jdbcType="VARCHAR" />
		<result column="IPHONE_CNT" property="iphoneCnt" jdbcType="VARCHAR" />
		<result column="SUM_CNT" property="sumCnt" jdbcType="VARCHAR" />
		<result column="PART_V_NM" property="partVNm" jdbcType="VARCHAR" />
	</resultMap>

	<!-- 조회조건에 대한 멤버십 목록 -->
	<select id="selectCouponOsStaticDayList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT
			  A.STAT_DAY
	 		, B.PART_V
			, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
			, C.COMP_ID 
			, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
			, A.CPN_ID
			, B.NAME
			, SUM(ANDROID_KT_CNT) AS ANDROID_KT_CNT
			, SUM(ANDROID_SKT_CNT) AS ANDROID_SKT_CNT
			, SUM(ANDROID_LGU_CNT) AS ANDROID_LGU_CNT
			, SUM(ANDROID_KT_CNT + ANDROID_SKT_CNT + ANDROID_LGU_CNT ) AS ANDROID_CNT
			, SUM(IPHONE_KT_CNT) AS IPHONE_KT_CNT
			, SUM(IPHONE_SKT_CNT) AS IPHONE_SKT_CNT
			, SUM(IPHONE_LGU_CNT) AS IPHONE_LGU_CNT
			, SUM(IPHONE_KT_CNT + IPHONE_SKT_CNT + IPHONE_LGU_CNT ) AS IPHONE_CNT
			, SUM(ANDROID_KT_CNT + ANDROID_SKT_CNT + ANDROID_LGU_CNT + IPHONE_KT_CNT + IPHONE_SKT_CNT + IPHONE_LGU_CNT ) AS SUM_CNT
		FROM MW_CS_CPN_DAY_STAT_OS_MO A
		       INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
		       INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
		       LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
			<if test='sdate!=null and sdate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) >=	REPLACE(#{sdate}, '-', '')
					]]>
				</if>
			</if>
			<if test='edate!=null and edate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) <=	REPLACE(#{edate}, '-', '')
					]]>
				</if>
			</if>
		</if>
		<if test='partV!=null and partV!=""'>
			AND B.part_v = #{partV}
		</if>
		<if test='name!=null and name!=""'>
			AND B.name LIKE '%${name}%'
		</if>
		<if test='compName!=null and compName!=""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		GROUP BY
		 A.STAT_DAY
		, B.PART_V 
		, C.COMP_ID 
		, A.CPN_ID
		, B.NAME
	</select>
	
	<resultMap type="hashMap" id="dataMap">
		<result property="contents" column="contents" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectCouponOsStaticMonthList" parameterType="map" resultMap="dataMap" >
		SELECT 
			  B.PART_V -- 쿠폰구분
			, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
			, C.COMP_ID -- 제휴사
			, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
			, A.CPN_ID
			, B.NAME
			, CASE WHEN OS_TYPE = '01' THEN '안드로이드' WHEN OS_TYPE = '02' THEN '아이폰' END AS OS_TYPE  -- OS구분 ( 01:안드로이드, 02:아이폰 )
			, CASE WHEN MO_TYPE = '01' THEN 'KT' WHEN MO_TYPE = '02' THEN 'SKT' WHEN MO_TYPE = '03' THEN 'LG U+' END AS MO_TYPE  -- 통신사구분 ( 01:KT, 02:SKT, 03:LGU )
			${subQuery}
			/*
			, SUM(CASE WHEN STAT_MONTH = '201209' THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT1 -- 기간만큼 필요
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+1,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT2
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+2,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT3
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+3,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(USER_CNT,0) ELSE 0 END) AS CNT4
			*/
			, SUM(ISNULL(USER_CNT,0)) AS SUM_CNT -- 합계
			
		FROM MW_CS_CPN_MONTH_STAT_OS_MO A
		       INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
		       INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
		       LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
			<if test='sdate!=null and sdate!=""'>
				<if test='se_termOpt == "monthDate"'>
					<![CDATA[
						AND STAT_MONTH >= LEFT(REPLACE(#{sdate}, '-', ''), 6)
					]]>
				</if>
			</if>
			<if test='edate!=null and edate!=""'>
				<if test='se_termOpt == "monthDate"'>
					<![CDATA[
						AND STAT_MONTH <= LEFT(REPLACE(#{edate}, '-', ''), 6)
					]]>
				</if>
			</if>
		</if>
		<if test='partV!=null and partV!=""'>
			AND B.part_v = #{partV}
		</if>
		<if test='name!=null and name!=""'>
			AND B.name LIKE '%${name}%'
		</if>
		<if test='compName!=null and compName!=""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		GROUP BY 
			  B.PART_V -- 쿠폰구분
			, C.COMP_ID -- 제휴사
			, A.CPN_ID
			, B.NAME
			, OS_TYPE   -- OS구분 ( 01:안드로이드, 02:아이폰 )
			, MO_TYPE   -- 통신사구분 ( 01:KT, 02:SKT, 03:LGU )

	</select>
	
</mapper>