<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.CouponShareMapper" >
  <resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.CouponShare" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    <result column="CPN_ID" property="cpnID" jdbcType="VARCHAR" />
    <result column="PART" property="part" jdbcType="VARCHAR" />
    <result column="NAME" property="cpnName" jdbcType="VARCHAR" />
    <result column="name" property="membName" jdbcType="VARCHAR" />
    <result column="REG_DTM" property="shareRegDtm" jdbcType="VARCHAR" />
    <result column="COMP_SHARE_RATIO" property="shareRatio" jdbcType="VARCHAR" />
    <result column="memb_id" property="membId" jdbcType="VARCHAR" />
    <result column="CHG_DTM" property="shareChgDtm" jdbcType="TIMESTAMP" />
    <result column="CPN_COST" property="cpnCost" jdbcType="VARCHAR" />
    <result column="CPN_MARK_COST" property="cpnMarkCost" jdbcType="VARCHAR" />
    <result column="COMMISSION" property="commission" jdbcType="VARCHAR" />
    <result column="OPER_COMPANY" property="operCompany" jdbcType="VARCHAR" />
    <result column="KT" property="kT" jdbcType="VARCHAR" />
    <result column="COOP_COMPANY" property="coopCompany" jdbcType="VARCHAR" />
    <result column="MEMBER_SHIP" property="membership" jdbcType="VARCHAR" />
    <result column="MEMBER_SHOP" property="memberShop" jdbcType="VARCHAR" />
    <result column="FINANCE_COMPANY" property="financeCompany" jdbcType="VARCHAR" />
    <result column="PAY_COMPANY" property="payCompany" jdbcType="VARCHAR" />
    <result column="BULKYN" property="bulkYn"  jdbcType="VARCHAR" />
	<result column="REG_USER" property="shareRegUser"  jdbcType="VARCHAR" />
	<result column="CHG_USER" property="shareChgUser"  jdbcType="VARCHAR" />
	
	<result column="REG_DTM_STR" property="regDtmStr" jdbcType="VARCHAR" />
    <result column="CHG_DTM_STR" property="chgDtmStr" jdbcType="VARCHAR" />
    
    <result column="PARTNER_NAME" property="partnerName" jdbcType="VARCHAR" />
    <result column="BRAND_NAME" property="brandName" jdbcType="VARCHAR" />
	<result column="PARTNER_ID" property="partnerId" jdbcType="VARCHAR" />
    <result column="BRAND_ID" property="brandId" jdbcType="VARCHAR" />
    
  </resultMap>

  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.wallet.membership.model.custom.CouponShare" >      
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    SELECT
    <if test="rowsPerPage != 0">
			top ${rowsPerPage}
		</if>
	 A.CPN_ID
    ,A.CHG_DTM
    ,A.CHG_USER
	, dbo.GET_CODE_NM('0030',B.PART_V) AS PART
	,B.NAME
	,D.name 
	,D.memb_id
	,(SELECT MAX(E.REG_DTM) FROM MW_CS_CPN_SHARERATIO E WHERE E.CPN_ID=A.CPN_ID) AS REG_DTM
	,(SELECT MAX(REG_USER) FROM MW_CS_CPN_SHARERATIO E WHERE E.CPN_ID=A.CPN_ID) AS REG_USER
	,(SELECT MAX(COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.CPN_ID=A.CPN_ID) AS COMP_SHARE_RATIO
    ,(SELECT COMP_NAME FROM MW_CM_COMPANY H WHERE A.BRAN_ID = H.COMP_ID) AS BRAND_NAME
    ,(SELECT COMP_ID FROM MW_CM_COMPANY H WHERE A.BRAN_ID = H.COMP_ID) AS BRAND_ID
    ,(SELECT COMP_NAME FROM MW_CM_COMPANY H WHERE A.COMP_ID = H.COMP_ID) AS PARTNER_NAME
    ,(SELECT COMP_ID FROM MW_CM_COMPANY H WHERE A.COMP_ID = H.COMP_ID) AS PARTNER_ID
    ,ISNULL((SELECT SUM(E.COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.COMP_TYPE='01' AND E.CPN_ID=A.CPN_ID),0)AS COOP_COMPANY
    ,ISNULL((SELECT SUM(E.COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.COMP_TYPE='02' AND E.CPN_ID=A.CPN_ID),0)AS FINANCE_COMPANY
    ,ISNULL((SELECT SUM(E.COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.COMP_TYPE='03' AND E.CPN_ID=A.CPN_ID),0)AS PAY_COMPANY
    ,ISNULL((SELECT SUM(E.COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.COMP_TYPE='04' AND E.CPN_ID=A.CPN_ID),0)AS MEMBER_SHIP
    ,ISNULL((SELECT SUM(E.COMP_SHARE_RATIO) FROM MW_CS_CPN_SHARERATIO E WHERE E.COMP_TYPE='05' AND E.CPN_ID=A.CPN_ID),0)AS MEMBER_SHOP
    ,(CONVERT(CHAR(10),(A.REG_DTM),23)) AS REG_DTM_STR
    ,(CONVERT(CHAR(10),(SELECT MAX(E.REG_DTM) FROM MW_CS_CPN_SHARERATIO E WHERE E.CPN_ID=A.CPN_ID),23)) AS CHG_DTM_STR
	,(SELECT COUNT(*) FROM MW_CS_CPN_SHARERATIO WHERE CPN_ID = A.CPN_ID)AS BULKYN
	FROM MW_CS_CPN_LIST A
	INNER JOIN cpn_list B ON A.CPN_ID = B.cpn_id
	LEFT OUTER JOIN memb_cardlist D ON B.memb_id = D.memb_id	
	WHERE A.CALCUL_YN = 'Y'

	<if test="cpnID != null">
		AND A.CPN_ID = '${cpnID}'
		</if> 
	<if test="partnerName != null">
		AND G.COMP_NAME LIKE '%${partnerName}%'
		</if>
	<if test="cpnName != null">
		AND B.NAME LIKE '%${cpnName}%'
	</if>	
	<if test="cuponPart != null">
		AND B.part_v = '${cuponPart}'
	</if>
	<if test="shStartDays != null "> 
	    <if test="shEndDays != null">
	AND A.REG_DTM BETWEEN '${shStartDays}' AND '${shEndDays}'
		</if>
	</if>
	order by A.REG_DTM DESC , B.NAME DESC 	

  </select>

  
  <select id="countByExample" resultType="java.lang.Integer"  parameterType="com.wallet.membership.model.custom.CouponShare">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Aug 14 13:40:21 KST 2012.
    -->
    SELECT count(*)  
	FROM MW_CS_CPN_LIST A
	INNER JOIN cpn_list B ON A.CPN_ID = B.cpn_id
	INNER JOIN memb_cardlist D ON B.memb_id = D.memb_id
	INNER JOIN MW_CM_COMPANY F ON D.BRAN_ID = F.COMP_ID	   
	INNER JOIN MW_CM_COMPANY G ON F.UPPER_COMP_ID = G.COMP_ID
	WHERE A.CALCUL_YN = 'Y'
	
	<if test="cpnID != null">
		AND A.CPN_ID = '${cpnID}'
		</if> 
	<if test="partnerName != null">
		AND G.COMP_NAME LIKE '%${partnerName}%'
		</if>
	<if test="cpnName != null">
		AND B.NAME LIKE '%${cpnName}%'
	</if>	
	<if test="cuponPart != null">
		AND B.part_v =  '${cuponPart}'
	</if>
	
	<if test="shStartDays != null "> 
	    <if test="shEndDays != null">
		AND ((SELECT MAX(Z.REG_DTM) FROM MW_CS_CPN_SHARERATIO Z WHERE Z.CPN_ID=A.CPN_ID) BETWEEN '${shStartDays}' AND '${shEndDays}')
		</if>
	</if>
	 
		</select>		

	
<!-- 	<if test="cuponPart != null">
		AND C.part_v = '${cuponPart}'
		</if>
	<if test="membName != null">
		AND D.name = '${membName}'
	</if>	 
	<if test="shStartDays != null "> 
	    <if test="shEndDays != null">
	AND (B.REG_DTM BETWEEN '${shStartDays}' AND '${shEndDays}')
		</if>
	</if>
	<if test="cpnName != null">
		AND C.NAME LIKE '%${cpnName}%'
	</if>	

		<if test="membId != null">
		AND C.memb_id='${membId}'
		</if>
		<if test="shStartDays != null "> 
		    <if test="shEndDays != null">
		AND (B.REG_DTM BETWEEN '${shStartDays}' AND '${shEndDays}')
			</if>
		</if>
		</select>		
 -->
<!-- 
	<update id="updateBycpnlistSelective" parameterType="com.wallet.membership.model.custom.CouponShare" >
		update cpn_list SET
		<if test="Part != null">
		PART = #{Part,jdbcType=VARCHAR},
		</if>
		<if test="CpnName != null">
		NAME = #{CpnName,jdbcType=VARCHAR}
		</if>
		where  CPN_ID = #{CpnID,jdbcType=VARCHAR}
	</update>	
	
	<update id="updateBymembcardlistSelective" parameterType="com.wallet.membership.model.custom.CouponShare" >
		<if test="MembName != null">
			update memb_cardlist
			SET name = #{MembName,jdbcType=VARCHAR}
			where  CPN_ID = #{CpnID,jdbcType=VARCHAR}
			
		</if>
	
	</update>	
 -->
     <update id="updateByMwCsCpnlistSelective" parameterType="com.wallet.membership.model.custom.CouponShare" >
        update MW_CS_CPN_LIST SET
        <if test="ShareChgDtm != null" > 
         CHG_DTM = #{shareChgDtm,jdbcType=TIMESTAMP},
        </if>
        <if test="shareChgUser != null" > 
         CHG_USER = #{shareChgUser,jdbcType=VARCHAR}
        </if> 
          where CPN_ID = #{cpnID,jdbcType=VARCHAR}	    	
 
 	</update>
<!-- 
 	<update id="updateByMWCSCPNSHARERATIOSelective" parameterType="com.wallet.membership.model.custom.CouponShare">
 		update MW_CS_CPN_SHARERATIO 
 		<set>
 		<if test="ShareRegDtm != null">
 		REG_DTM = #{ShareRegDtm,jdbcType=VARCHAR},
 		</if>
 		<if test="shareRegUser != null">
 		REG_USER = #{shareRegUser,jdbcType=VARCHAR}
 		</if>
 		</set>
           where CPN_ID = #{CpnID,jdbcType=VARCHAR}	    	
  	</update>
  --> 	
  	
  	<insert id="insertSelective" parameterType="com.wallet.membership.model.custom.CouponShare">  	
  	</insert>
</mapper>