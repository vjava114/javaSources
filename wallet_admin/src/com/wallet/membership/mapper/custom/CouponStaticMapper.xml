<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.CouponStaticMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.CouponStatic" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="CPN_ID" property="cpnId" jdbcType="VARCHAR" />
		<result column="STAT_DAY" property="statDay" jdbcType="VARCHAR" />
		<result column="DOWN_CNT" property="downCnt" jdbcType="VARCHAR" />
		<result column="DEL_CNT" property="delCnt" jdbcType="VARCHAR" />
		<result column="AUTH_CNT" property="authCnt" jdbcType="VARCHAR" />
		<result column="AUTH_CANCEL_CNT" property="authCancelCnt" jdbcType="VARCHAR" />
		<result column="SELL_CNT" property="sellCnt" jdbcType="VARCHAR" />
		<result column="SELL_CANCEL_CNT" property="sellCancelCnt" jdbcType="VARCHAR" />
		<result column="PART_V" property="partV" jdbcType="VARCHAR" />
		<result column="NAME" property="name" jdbcType="VARCHAR" />
		<result column="COMP_NAME" property="compName" jdbcType="VARCHAR" />
		<result column="PART_V_NM" property="partVNm" jdbcType="VARCHAR" />
	</resultMap>

	<!-- 조회조건에 대한 멤버십 목록 -->
	<select id="selectCouponStaticDayList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT
			  SUBSTRING(A.STAT_DAY,0,5)+'-'+SUBSTRING(A.STAT_DAY,5,2)+'-'+SUBSTRING(A.STAT_DAY,7,2) as STAT_DAY
			, B.PART_V -- 쿠폰구분
			, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
			, C.COMP_ID -- 제휴사
			, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
			, A.CPN_ID
			, B.NAME
			, SUM(A.DOWN_CNT) AS DOWN_CNT
			, SUM(A.DEL_CNT) AS DEL_CNT
			, SUM(A.AUTH_CNT) AS AUTH_CNT
			, SUM(A.AUTH_CANCEL_CNT) AS AUTH_CANCEL_CNT
			, SUM(A.SELL_CNT) AS SELL_CNT
			, SUM(A.SELL_CANCEL_CNT) AS SELL_CANCEL_CNT
		FROM MW_CS_CPN_DAY_STAT A
				INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
				INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
				LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
			<if test='sdate!=null and sdate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) >=	REPLACE(#{sdate}, '-', '')
					]]>
				</if>
			</if>
			<if test='edate!=null and edate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND CONVERT(VARCHAR(8), STAT_DAY, 112) <=	REPLACE(#{edate}, '-', '')
					]]>
				</if>
			</if>
		</if>
		<if test='partV!=null and partV!=""'>
			AND B.part_v = #{partV}
		</if>
		<if test='name!=null and name!=""'>
			AND B.NAME LIKE '%${name}%'
		</if>
		<if test='compName!=null and compName!=""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		GROUP BY A.STAT_DAY
			, B.PART_V 
			, C.COMP_ID 
			, A.CPN_ID
			, B.NAME
	</select>
	
	<resultMap type="hashMap" id="dataMap">
		<result property="contents" column="contents" jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>
	
	<select id="selectCouponStaticMonthList" parameterType="map" resultMap="dataMap" >
		SELECT
			B.PART_V 
			, dbo.GET_CODE_NM('0030',B.PART_V) AS PART_V_NM
			, C.COMP_ID 
			, dbo.GET_COMP_NM(C.COMP_ID) AS COMP_NAME
			, A.CPN_ID
			, B.NAME
			, CASE WHEN STAT_TYPE='11' THEN  '다운로드 ' WHEN STAT_TYPE='12' THEN '삭제' WHEN STAT_TYPE='13' THEN '승인' WHEN STAT_TYPE='14' THEN '승인취소' WHEN STAT_TYPE='15' THEN '판매' WHEN STAT_TYPE='16' THEN '판매취소'END AS STAT_TYPE
			${subQuery}
			/*
			, SUM(CASE WHEN STAT_MONTH = '201209' THEN ISNULL(A.USER_CNT,0) ELSE 0 END) AS CNT1 -- 기간만큼 필요
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+1,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(A.USER_CNT,0) ELSE 0 END) AS CNT2
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+2,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(A.USER_CNT,0) ELSE 0 END) AS CNT3
			, SUM(CASE WHEN STAT_MONTH = SUBSTRING( REPLACE(CONVERT(VARCHAR(50),DATEADD(M,+3,CONVERT(datetime,'201209'+'01')),120),'-',''),1,6) THEN ISNULL(A.USER_CNT,0) ELSE 0 END) AS CNT4
			*/
			, SUM(ISNULL(A.USER_CNT,0)) AS SUM_CNT
		FROM MW_CS_CPN_MONTH_STAT A
				INNER JOIN CPN_LIST B ON A.CPN_ID = B.CPN_ID
				INNER JOIN MW_CS_CPN_LIST C ON A.CPN_ID = C.CPN_ID
				LEFT OUTER JOIN MW_CM_COMPANY D ON C.COMP_ID = D.COMP_ID
		WHERE 1=1
		<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
			<if test='sdate!=null and sdate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND STAT_MONTH >= LEFT(REPLACE(#{sdate}, '-', ''), 6)
					]]>
				</if>
			</if>
			<if test='edate!=null and edate!=""'>
				<if test='se_termOpt == "dayDate"'>
					<![CDATA[
						AND STAT_MONTH <= LEFT(REPLACE(#{edate}, '-', ''), 6)
					]]>
				</if>
			</if>
		</if>
		<if test='partV!=null and partV!=""'>
			AND B.part_v = #{partV}
		</if>
		<if test='name!=null and name!=""'>
			AND B.NAME LIKE '%${name}%'
		</if>
		<if test='compName!=null and compName!=""'>
			AND D.COMP_NAME LIKE '%${compName}%'
		</if>
		GROUP BY
			  B.PART_V
			, C.COMP_ID
			, A.CPN_ID
			, B.NAME
			, STAT_TYPE
		ORDER BY
			  B.PART_V
			, C.COMP_ID 
			, A.CPN_ID
			, B.NAME
			, STAT_TYPE
	</select>
	
</mapper>