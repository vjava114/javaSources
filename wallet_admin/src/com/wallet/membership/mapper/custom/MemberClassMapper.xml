<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.MemberClassMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.MemberClass" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="MEMB_ID" property="membId" jdbcType="VARCHAR" />
		<result column="NAME" property="name" jdbcType="VARCHAR" />
		<result column="CLASS_CODE" property="classCode" jdbcType="VARCHAR" />
		<result column="CLASS_NAME" property="className" jdbcType="VARCHAR" />
		<result column="ADD_DC_RATE" property="addDcRate" jdbcType="VARCHAR" />
		<result column="ADD_SAVE_RATE" property="addSaveRate" jdbcType="VARCHAR" />
		<result column="REG_USER" property="regUser" jdbcType="VARCHAR" />
		<result column="REG_USER_NM" property="regUserNm" jdbcType="VARCHAR" />
		<result column="REG_DTM" property="regDtm" jdbcType="VARCHAR" />
		<result column="CHG_USER" property="chgUser" jdbcType="VARCHAR" />
		<result column="CHG_USER_NM" property="chgUserNm" jdbcType="VARCHAR" />
		<result column="CHG_DTM" property="chgDtm" jdbcType="VARCHAR" />
		<result column="ADD_USE_RATE" property="addUseRate" jdbcType="VARCHAR" />
		
		<result column="MEM_LIST_3GS" property="listImg_i3GS" jdbcType="VARCHAR" />
		<result column="MEM_LIST_4S" property="listImg_i4S" jdbcType="VARCHAR" />
		<result column="MEM_LIST_ANDROID" property="listImg_android" jdbcType="VARCHAR" />

		<result column="MEM_DETAIL_3GS" property="detailImg_i3GS" jdbcType="VARCHAR" />
		<result column="MEM_DETAIL_4S" property="detailImg_i4S" jdbcType="VARCHAR" />
		<result column="MEM_DETAIL_ANDROID" property="detailImg_android" jdbcType="VARCHAR" />
		
	</resultMap>

	<!-- 조회조건에 대한 결제사 목록 -->
	<select id="selectMemberClassList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT *
		FROM (
			SELECT <if test='top != null and top != ""'> top ${top} </if>
				ROW_NUMBER() OVER(ORDER BY S.REG_DTM DESC) AS IDX
				, S.MEMB_ID
				, M.NAME
				, S.CLASS_CODE
				, S.CLASS_NAME
				, S.ADD_DC_RATE
				, S.ADD_SAVE_RATE
				, S.ADD_USE_RATE
				, S.REG_USER
				/*, U1.AUTH_NAME AS REG_USER_NM*/
				, CONVERT(VARCHAR(10), S.REG_DTM, 120) as REG_DTM
				, S.CHG_USER
				/*, U2.AUTH_NAME AS CHG_USER_NM*/
				, CONVERT(VARCHAR(10), S.CHG_DTM, 120) as CHG_DTM
				, I.*
			FROM MW_MS_MEMB_CLASS S, MEMB_CARDLIST M, /*, USER_DESC U1, USER_DESC U2*/
			(
				SELECT ID
					, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_3GS
					, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_4S
					, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_ANDROID
					, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_3GS
					, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_4S
					, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_ANDROID
					, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_3GS
					, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_4S
					, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_ANDROID
					, LEVEL
				FROM MW_CM_IMAGE I
				WHERE 1=1
				<if test='level != null'>
					AND LEVEL = #{level}
				</if>
				GROUP BY ID, LEVEL
			) I /*, USER_DESC U1, USER_DESC U2*/
			WHERE S.MEMB_ID = I.ID
			AND S.MEMB_ID = M.MEMB_ID
			AND S.CLASS_CODE = I.LEVEL
			/*
			AND U1.USER_ID = S.REG_USER
			AND U2.USER_ID = S.CHG_USER
			*/
			<if test='membId != null and membId != ""'>
				AND S.MEMB_ID = #{membId}
			</if>
			) A
		WHERE 1=1
		<if test='startRow != null and startRow != ""'>
			<if test='rowsPerPage != null and rowsPerPage != ""'>
 				AND A.IDX BETWEEN #{startRow, jdbcType=INTEGER} AND #{endRow, jdbcType=INTEGER}
			</if>
		</if>
	</select>
	
	<!-- 조회조건에 대한 결제사 총 수 -->
	<select id="selectMemberClassListCnt" parameterType="HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*) AS CNT
		FROM MW_MS_MEMB_CLASS S
		WHERE 1=1
		<if test='membId != null and membId != ""'>
			AND S.MEMB_ID = #{membId}
		</if>
	</select>
	
	<!-- 조회조건에 대한 결제사 목록 -->
	<select id="selectMemberClassInfo" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT S.MEMB_ID
			, M.NAME
			, S.CLASS_CODE
			, S.CLASS_NAME
			, S.ADD_DC_RATE
			, S.ADD_SAVE_RATE
			, S.ADD_USE_RATE
			, S.REG_USER
			/*, U1.AUTH_NAME AS REG_USER_NM*/
			, CONVERT(VARCHAR(10), S.REG_DTM, 120) as REG_DTM
			, S.CHG_USER
			/*, U2.AUTH_NAME AS CHG_USER_NM*/
			, CONVERT(VARCHAR(10), S.CHG_DTM, 120) as CHG_DTM
			, I.*
		FROM MW_MS_MEMB_CLASS S, MEMB_CARDLIST M , /*, USER_DESC U1, USER_DESC U2*/
		(
			SELECT ID
				, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_3GS
				, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_4S
				, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='02' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_LIST_ANDROID
				, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_3GS
				, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_4S
				, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='03' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEM_DETAIL_ANDROID
				, MAX(CASE WHEN I.OS_TYPE='01' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_3GS
				, MAX(CASE WHEN I.OS_TYPE='02' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_4S
				, MAX(CASE WHEN I.OS_TYPE='11' AND I.USE_TYPE='04' THEN /*I.IMAGE_HOST+*/I.IMAGE_URL END) AS MEMBER_ANDROID
				, LEVEL
			FROM MW_CM_IMAGE I
			WHERE 1=1
			<if test='level != null'>
				AND LEVEL = #{level}
			</if>
			GROUP BY ID, LEVEL
		) I 
		WHERE 1=1
		AND S.MEMB_ID = I.ID
		AND S.MEMB_ID = M.MEMB_ID
		AND S.CLASS_CODE = I.LEVEL
		/*
		AND U1.USER_ID = S.REG_USER
		AND U2.USER_ID = S.CHG_USER
		*/
		AND S.MEMB_ID = #{membId}
		AND S.CLASS_CODE = #{classCode}
	</select>

	<insert id="insertMemberClass" parameterType="HashMap">
		INSERT INTO MW_MS_MEMB_CLASS
		<trim prefix="(" suffix=")" suffixOverrides="," >
				MEMB_ID,
			<if test='classCode != null and classCode != ""' >CLASS_CODE,</if>
			<if test='className != null and className != ""' >CLASS_NAME,</if>
			<if test='addDcRate != null and addDcRate != ""' >ADD_DC_RATE,</if>
			<if test='addSaveRate != null and addSaveRate != ""' >ADD_SAVE_RATE,</if>
			<if test='addUseRate != null and addUseRate != ""' >ADD_USE_RATE,</if>
<!-- 			<if test='cardClassImg_i3GS != null and cardClassImg_i3GS != ""' >ADD_SAVE_RATE,</if> -->
<!-- 			<if test='cardClassImg_i4S != null and cardClassImg_i4S != ""' >ADD_SAVE_RATE,</if> -->
<!-- 			<if test='cardClassImg_android != null and cardClassImg_android != ""' >ADD_SAVE_RATE,</if> -->
				REG_USER,
				REG_DTM,
		</trim>
		<trim prefix="VALUES(" suffix=")" suffixOverrides="," >
			#{membId},
			<if test='classCode != null and classCode != ""' >#{classCode},</if>
			<if test='className != null and className != ""' >#{className},</if>
			<if test='addDcRate != null and addDcRate != ""' >#{addDcRate},</if>
			<if test='addSaveRate != null and addSaveRate != ""' >#{addSaveRate},</if>
			<if test='addUseRate != null and addUseRate != ""' >#{addUseRate},</if>
<!-- 			<if test='cardClassImg_i3GS != null and cardClassImg_i3GS != ""' >#{cardClassImg_i3GS},</if> -->
<!-- 			<if test='cardClassImg_i4S != null and cardClassImg_i4S != ""' >#{cardClassImg_i4S},</if> -->
<!-- 			<if test='cardClassImg_android != null and cardClassImg_android != ""' >#{cardClassImg_android},</if> -->
			#{regUser},
			GETDATE(),
		</trim>
	</insert>

	<update id="updateMemberClass" parameterType="HashMap">
		UPDATE MW_MS_MEMB_CLASS
		<set >
		<trim prefix="" suffix="" suffixOverrides="," >
			<if test='className != null and className != ""' >CLASS_NAME = #{className},</if>
			<if test='addDcRate != null and addDcRate != ""' >ADD_DC_RATE = #{addDcRate},</if>
			<if test='addSaveRate != null and addSaveRate != ""' >ADD_SAVE_RATE = #{addSaveRate},</if>
			<if test='addUseRate != null and addUseRate != ""' >ADD_USE_RATE = #{addUseRate},</if>
				CHG_USER = #{chgUser},
				CHG_DTM = GETDATE(),
		</trim>
		</set>
		WHERE MEMB_ID = #{membId}
		AND CLASS_CODE=#{classCode}
	</update>
	
	<delete id="deleteMemberClass" parameterType="HashMap">
		DELETE
		FROM MW_MS_MEMB_CLASS
		WHERE MEMB_ID = #{membId}
		AND CLASS_CODE = #{classCode}
	</delete>
</mapper>