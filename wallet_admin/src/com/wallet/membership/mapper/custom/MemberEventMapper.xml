<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.MemberEventMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.MemberEvent" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="NOTI_ID" property="notiId" jdbcType="VARCHAR" />
		<result column="NOTI_TARGET" property="notiTarget" jdbcType="VARCHAR" />
		<result column="ID" property="id" jdbcType="VARCHAR" />
		<result column="NOTI_TYPE" property="notiType" jdbcType="VARCHAR" />
		<result column="TITLE" property="title" jdbcType="VARCHAR" />
		<result column="CONTENT" property="content" jdbcType="VARCHAR" />
		<result column="IMAGE_URL" property="imageUrl" jdbcType="VARCHAR" />
		<result column="NEW_NOTI" property="newNoti" jdbcType="VARCHAR" />
		<result column="VAL_SDAY" property="valSday" jdbcType="VARCHAR" />
		<result column="VAL_EDAY" property="valEday" jdbcType="VARCHAR" />
		<result column="DISPLAY_YN" property="displayYn" jdbcType="VARCHAR" />
		<result column="REG_USER" property="regUser" jdbcType="VARCHAR" />
		<result column="REG_DTM" property="regDtm" jdbcType="VARCHAR" />
		<result column="CHG_USER" property="chgUser" jdbcType="VARCHAR" />
		<result column="CHG_DTM" property="chgDtm" jdbcType="VARCHAR" />
		<result column="memb_id" property="membId" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="NOTI_ID" property="notiId" jdbcType="VARCHAR" />
	</resultMap>

	<!-- 조회조건에 대한 공지사항/이벤트 목록 -->
	<select id="selectMemberEventList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT *
		FROM (
			SELECT <if test='top!=null and top!=""'> top ${top} </if>
				ROW_NUMBER() OVER(ORDER BY N.REG_DTM DESC) AS IDX
				, N.NOTI_ID
				, N.NOTI_TYPE
				, N.TITLE
				, N.DISPLAY_YN
				, C.memb_id
				, C.name
				, SUBSTRING(N.VAL_SDAY,0,5)+'-'+SUBSTRING(N.VAL_SDAY,5,2)+'-'+SUBSTRING(N.VAL_SDAY,7,2) as VAL_SDAY
				, SUBSTRING(N.VAL_EDAY,0,5)+'-'+SUBSTRING(N.VAL_EDAY,5,2)+'-'+SUBSTRING(N.VAL_EDAY,7,2) as VAL_EDAY
				, CONVERT(VARCHAR(10), N.REG_DTM, 120) as REG_DTM
				, CONVERT(VARCHAR(10), N.CHG_DTM, 120) as CHG_DTM
			FROM MW_CM_NOTICE N, memb_cardlist C
			WHERE 1=1
			AND C.memb_id = N.ID
			AND N.NOTI_TARGET='02'
			<if test='notiId!=null and notiId!=""'>
				AND N.NOTI_ID = #{notiId}
			</if>
			<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
				<if test='sdate!=null and sdate!=""'>
					<if test='se_termOpt == "reg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), N.REG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					<if test='se_termOpt == "chg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), N.CHG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					
					<if test='edate!=null and edate!=""'>
						<if test='se_termOpt == "reg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), N.REG_DTM, 120) <=	#{edate}
							]]>
						</if>
						<if test='se_termOpt == "chg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), N.CHG_DTM, 120) <=	#{edate}
							]]>
						</if>
					</if>
				</if>
			</if>
			<if test='se_termOpt == "chg_date"'>
   				AND N.CHG_DTM IS NOT NULL
  			</if>
			<if test='seMembName!=null and seMembName!=""'>
				AND C.name LIKE '%${seMembName}%'
			</if>
			<if test='notiType!=null and notiType!="" and notiType!="all"'>
				AND N.NOTI_TYPE = #{notiType}
			</if>
			<if test='displayYn!=null and displayYn!=""'>
				AND N.DISPLAY_YN = #{displayYn}
			</if>
			) A
		WHERE 1=1
		<if test='startRow!=null and startRow!=""'>
			<if test='rowsPerPage!=null and rowsPerPage!=""'>
 				AND A.IDX BETWEEN #{startRow, jdbcType=INTEGER} AND #{endRow, jdbcType=INTEGER}
			</if>
		</if>
	</select>
	
	<!-- 조회조건에 대한 공지사항/이벤트 총 수 -->
	<select id="selectMemberEventListCnt" parameterType="HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*) AS CNT
		FROM MW_CM_NOTICE N, memb_cardlist C
		WHERE 1=1
		AND C.memb_id = N.ID
		AND N.NOTI_TARGET='02'
		<if test='notiId!=null and notiId!=""'>
				AND N.NOTI_ID = #{notiId}
			</if>
			<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
				<if test='sdate!=null and sdate!=""'>
					<if test='se_termOpt == "reg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), N.REG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					<if test='se_termOpt == "chg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), N.CHG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					
					<if test='edate!=null and edate!=""'>
						<if test='se_termOpt == "reg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), N.REG_DTM, 120) <=	#{edate}
							]]>
						</if>
						<if test='se_termOpt == "chg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), N.CHG_DTM, 120) <=	#{edate}
							]]>
						</if>
					</if>
				</if>
			</if>
			<if test='se_termOpt == "chg_date"'>
 				AND N.CHG_DTM IS NOT NULL
 			</if>
			<if test='seMembName!=null and seMembName!=""'>
				AND C.name LIKE '%${seMembName}%'
			</if>
			<if test='notiType!=null and notiType!="" and notiType!="all"'>
				AND N.NOTI_TYPE = #{notiType}
			</if>
			<if test='displayYn!=null and displayYn!=""'>
				AND N.DISPLAY_YN = #{displayYn}
			</if>
	</select>
	
	<!-- 조회조건에 대한 공지사항/이벤트 목록 -->
	<select id="selectMemberEventInfo" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT 
			C.name,
			N.NOTI_TYPE,
			N.TITLE,
			C.memb_id,
			SUBSTRING(N.VAL_SDAY,0,5)+'-'+SUBSTRING(N.VAL_SDAY,5,2)+'-'+SUBSTRING(N.VAL_SDAY,7,2) as VAL_SDAY,
			SUBSTRING(N.VAL_EDAY,0,5)+'-'+SUBSTRING(N.VAL_EDAY,5,2)+'-'+SUBSTRING(N.VAL_EDAY,7,2) as VAL_EDAY,
			CONVERT(VARCHAR(10), N.REG_DTM, 120) as REG_DTM,
			CONVERT(VARCHAR(10), N.CHG_DTM, 120) as CHG_DTM,
			N.CONTENT,
			N.DISPLAY_YN,
			N.REG_USER,
			N.CHG_USER,
			N.NOTI_ID
		FROM MW_CM_NOTICE N, memb_cardlist C
		WHERE 1=1
		AND C.memb_id = N.ID
		AND N.NOTI_ID=#{notiId}
	</select>

	<insert id="insertMemberEvent" parameterType="HashMap">
		INSERT INTO MW_CM_NOTICE
		<trim prefix="(" suffix=")" suffixOverrides="," >
				NOTI_ID,
				NOTI_TARGET,
				<if test='membId!=null and membId!=""' >ID,</if>
				<if test='notiType!=null and notiType!=""' >NOTI_TYPE,</if>
				<if test='title!=null and title!=""' >TITLE,</if>
				<if test='content!=null and content!=""' >CONTENT,</if>
				<if test='newNoti!=null and newNoti!=""' >NEW_NOTI,</if>
				REG_USER,
				REG_DTM,
				<if test='valSday!=null and valSday!=""' >VAL_SDAY,</if>
				<if test='valEday!=null and valEday!=""' >VAL_EDAY,</if>
				<if test='displayYn!=null and displayYn!=""' >DISPLAY_YN,</if>
		</trim>
		<trim prefix="" suffix="" suffixOverrides="," >
			SELECT 'NOT' + SUBSTRING(REPLICATE('0',9),0,10-LEN(ISNULL(RIGHT(MAX(NOTI_ID),9),0)+1)) + LTRIM(STR((ISNULL(RIGHT(MAX(NOTI_ID),9),0)+1))) , 
			'02',
			<if test='membId!=null and membId!=""' >#{membId},</if>
			<if test='notiType!=null and notiType!=""' >#{notiType},</if>
			<if test='title!=null and title!=""' >#{title},</if>
			<if test='content!=null and content!=""' >#{content},</if>
			<if test='newNoti!=null and newNoti!=""' >#{newNoti},</if>
				#{regUser},
				GETDATE(),
			<if test='valSday!=null and valSday!=""' >REPLACE(#{valSday}, '-', ''),</if>
			<if test='valEday!=null and valEday!=""' >REPLACE(#{valEday}, '-', ''),</if>
			<if test='displayYn!=null and displayYn!=""' >#{displayYn},</if>
		</trim>
			FROM MW_CM_NOTICE
	</insert>

	<update id="updateMemberEvent" parameterType="HashMap">
		UPDATE MW_CM_NOTICE
		<set>
		<trim prefix="" suffix="" suffixOverrides="," >
			NOTI_TYPE = #{notiType},
			TITLE = #{title},
			VAL_SDAY = REPLACE(#{valSday}, '-', ''),
			VAL_EDAY = REPLACE(#{valEday}, '-', ''),
			<if test="content != null and content !=''">CONTENT = #{content},</if>
			DISPLAY_YN = #{displayYn},
			CHG_USER = #{chgUser},
			CHG_DTM = getDate(),
		</trim>
		</set>
		WHERE 1=1
		AND NOTI_ID=#{notiId}
	</update>
	
	<delete id="deleteMemberEvent" parameterType="HashMap">
		DELETE 
		FROM MW_CM_NOTICE
		WHERE NOTI_ID=#{notiId}
	</delete>
</mapper>