<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wallet.membership.mapper.custom.PosMapper" >
	<resultMap id="BaseResultMap" type="com.wallet.membership.model.custom.Pos" >
	<!--
	WARNING - @mbggenerated
	This element is automatically generated by MyBatis Generator, do not modify.
	This element was generated on Tue Aug 14 13:40:21 KST 2012.
	-->
		<result column="IDX" property="idx" jdbcType="VARCHAR" />
		<result column="COMP_ID" property="shpCompId" jdbcType="VARCHAR" />
		<result column="COMP_NAME" property="shpCompName" jdbcType="VARCHAR" />
		<result column="COMP_ID_BRD" property="brdCompId" jdbcType="VARCHAR" />
		<result column="COMP_NAME_BRD" property="brdCompName" jdbcType="VARCHAR" />
		<result column="COMP_ID_CMP" property="cmpCompId" jdbcType="VARCHAR" />
		<result column="COMP_NAME_CMP" property="cmpCompName" jdbcType="VARCHAR" />
		<result column="POS_ID" property="posId" jdbcType="VARCHAR" />
		<result column="POS_DET_CODE" property="posDetCode" jdbcType="VARCHAR" />
		<result column="MEMO" property="memo" jdbcType="VARCHAR" />
		<result column="REG_USER" property="regUser" jdbcType="VARCHAR" />
		<result column="REG_DTM" property="regDtm" jdbcType="VARCHAR" />
		<result column="CHG_USER" property="chgUser" jdbcType="VARCHAR" />
		<result column="CHG_DTM" property="chgDtm" jdbcType="VARCHAR" />
		<result column="ALLY_STAT" property="allyStat" jdbcType="VARCHAR" />
		<result column="MANAGER_NAME" property="managerName" jdbcType="VARCHAR" />
		<result column="MAIN_NUMBER" property="mainNumber" jdbcType="VARCHAR" />
		<result column="BUSINESS_NO" property="businessNo" jdbcType="VARCHAR" />
		<result column="ZIPCODE" property="zipcode" jdbcType="VARCHAR" />
		<result column="ADDR" property="addr" jdbcType="VARCHAR" />
		<result column="ADDR_DETAIL" property="addrDetail" jdbcType="VARCHAR" />
		<result column="PHONE_NO" property="phoneNo" jdbcType="VARCHAR" />
		<result column="MOBILE_PHONE" property="mobilePhone" jdbcType="VARCHAR" />
		<result column="EMAIL" property="email" jdbcType="VARCHAR" />
		
	</resultMap>

	<!-- 조회조건에 대한 POS 목록 -->
	<select id="selectPosList" parameterType="HashMap" resultMap="BaseResultMap" >
		SELECT * 
		FROM (
			SELECT <if test='top!=null and top!=""'> top ${top} </if>
				ROW_NUMBER() OVER(ORDER BY P.REG_DTM DESC) AS IDX 
     			, S.COMP_NAME AS COMP_NAME_CMP
				, S1.COMP_NAME AS COMP_NAME_BRD
				, S2.COMP_NAME 
				, S2.MANAGER_NAME
				, S2.MOBILE_PHONE
				, S2.PHONE_NO
				, S2.ALLY_STAT
				, CONVERT(VARCHAR(10), P.REG_DTM, 120) as REG_DTM
				, CONVERT(VARCHAR(10), P.CHG_DTM, 120) as CHG_DTM
				, P.REG_USER
				, P.CHG_USER
				, P.COMP_ID
				, P.POS_DET_CODE
				, P.POS_ID
			FROM MW_CM_POS_LIST P, MW_CM_COMPANY S, MW_CM_COMPANY S1, MW_CM_COMPANY S2
			WHERE 1=1
			AND P.COMP_ID = S2.COMP_ID
			AND S2.UPPER_COMP_ID = S1.COMP_ID
			AND S1.UPPER_COMP_ID = S.COMP_ID
			<if test='shpCompId!=null and shpCompId!=""'>
				AND P.COMP_ID = #{shpCompId}
			</if>
			<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
				<if test='sdate!=null and sdate!=""'>
					<if test='se_termOpt == "reg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), P.REG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					<if test='se_termOpt == "chg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), P.CHG_DTM, 120) >=	#{sdate}
						]]>
					</if>
			
					<if test='edate!=null and edate!=""'>
						<if test='se_termOpt == "reg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), P.REG_DTM, 120) <=	#{edate}
							]]>
						</if>
						<if test='se_termOpt == "chg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), P.CHG_DTM, 120) <=	#{edate}
							]]>
						</if>
					</if>
				</if>
			</if>
			<if test='se_termOpt == "chg_date"'>
				AND P.CHG_DTM IS NOT NULL
			</if>
			<if test='seCmpCompName!=null and seCmpCompName!=""'>
				AND S.COMP_NAME LIKE '%${seCmpCompName}%'
			</if>
			<if test='seBrdCompName!=null and seBrdCompName!=""'>
				AND S1.COMP_NAME LIKE '%${seBrdCompName}%'
			</if>
			<if test='seShpCompName!=null and seShpCompName!=""'>
				AND S2.COMP_NAME LIKE '%${seShpCompName}%'
			</if>
			<if test='ra_allyStat!=null and ra_allyStat!="" and ra_allyStat!="all"'>
				AND S.ALLY_STAT = #{ra_allyStat}
			</if>
			) A
		WHERE 1=1
		<if test='startRow!=null and startRow!=""'>
			<if test='rowsPerPage!=null and rowsPerPage!=""'>
 				AND A.IDX BETWEEN #{startRow, jdbcType=INTEGER} AND #{endRow, jdbcType=INTEGER}
			</if>
		</if>
	</select>
	
	<!-- 조회조건에 대한 영업대행사 총 수 -->
	<select id="selectPosListCnt" parameterType="HashMap" resultType="java.lang.Integer">
		SELECT COUNT(*) AS CNT
		FROM MW_CM_POS_LIST P, MW_CM_COMPANY S, MW_CM_COMPANY S1, MW_CM_COMPANY S2
			WHERE 1=1
			AND P.COMP_ID = S2.COMP_ID
			AND S2.UPPER_COMP_ID = S1.COMP_ID
			AND S1.UPPER_COMP_ID = S.COMP_ID
			<if test='shpCompId!=null and shpCompId!=""'>
				AND P.COMP_ID = #{shpCompId}
			</if>
			<if test='ra_searchTerm!=null and ra_searchTerm!="" and ra_searchTerm!="all"'>
				<if test='sdate!=null and sdate!=""'>
					<if test='se_termOpt == "reg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), P.REG_DTM, 120) >=	#{sdate}
						]]>
					</if>
					<if test='se_termOpt == "chg_date"'>
						<![CDATA[
							AND CONVERT(VARCHAR(10), P.CHG_DTM, 120) >=	#{sdate}
						]]>
					</if>
				
					<if test='edate!=null and edate!=""'>
						<if test='se_termOpt == "reg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), P.REG_DTM, 120) <=	#{edate}
							]]>
						</if>
						<if test='se_termOpt == "chg_date"'>
							<![CDATA[
								AND CONVERT(VARCHAR(10), P.CHG_DTM, 120) <=	#{edate}
							]]>
						</if>
					</if>
				</if>
			</if>
			<if test='se_termOpt == "chg_date"'>
 				AND P.CHG_DTM IS NOT NULL
 			</if>
			<if test='seCmpCompName!=null and seCmpCompName!=""'>
				AND S.COMP_NAME LIKE '%${seCmpCompName}%'
			</if>
			<if test='seBrdCompName!=null and seBrdCompName!=""'>
				AND S1.COMP_NAME LIKE '%${seBrdCompName}%'
			</if>
			<if test='seShpCompName!=null and seShpCompName!=""'>
				AND S2.COMP_NAME LIKE '%${seShpCompName}%'
			</if>
			<if test='ra_allyStat!=null and ra_allyStat!="" and ra_allyStat!="all"'>
				AND S2.ALLY_STAT = #{ra_allyStat}
			</if>
			
	</select>
	
	<!-- 조회조건에 대한 영업대행사 목록 -->
	<select id="selectPosInfo" parameterType="HashMap" resultMap="BaseResultMap" >
	SELECT S.COMP_NAME AS COMP_NAME_CMP
				, S1.COMP_NAME AS COMP_NAME_BRD
				, S2.COMP_NAME 
				, S2.BUSINESS_NO
				, S2.ADDR
				, S2.ADDR_DETAIL
				, S2.ZIPCODE
				, S2.MANAGER_NAME
				, S2.PHONE_NO
				, S2.MOBILE_PHONE
				, S2.EMAIL
				, S2.MAIN_NUMBER
				, P.POS_ID
				, P.POS_DET_CODE
				, P.MEMO
				, convert(VARCHAR(200), P.MEMO) AS TEST
				, CONVERT(VARCHAR(10), P.REG_DTM, 120) as REG_DTM
				, CONVERT(VARCHAR(10), P.CHG_DTM, 120) as CHG_DTM
				, P.REG_USER
				, P.CHG_USER
	FROM MW_CM_POS_LIST P, MW_CM_COMPANY S, MW_CM_COMPANY S1, MW_CM_COMPANY S2
	WHERE 1=1
	AND P.COMP_ID = S2.COMP_ID
	AND S2.UPPER_COMP_ID = S1.COMP_ID
	AND S1.UPPER_COMP_ID = S.COMP_ID
	AND P.POS_ID = #{posId}
	</select>

	<insert id="insertPos" parameterType="HashMap">
		INSERT INTO MW_CM_POS_LIST
		<trim prefix="(" suffix=")" suffixOverrides="," >
				COMP_ID,
				POS_DET_CODE,
				<if test='memo!=null and memo!=""' >MEMO,</if>
				REG_USER,
				REG_DTM,
		</trim>
		Values(
			#{shpCompId},
			#{posDetCode},
			<if test='memo!=null and memo!=""' >#{memo},</if>
			#{regUser},
			GETDATE()
		)
	</insert>

	<update id="updatePos" parameterType="HashMap">
		UPDATE MW_CM_POS_LIST
		<set>
		<trim prefix="" suffix="" suffixOverrides="," >
			
			<if test='memo!=null and memo!=""' >
				MEMO = #{memo},
			</if>
			<if test='memo ==null or memo ==""' >
				MEMO = '',
			</if>
			<if test='posDetCode!=null and posDetCode!=""' >
				POS_DET_CODE = #{posDetCode},
			</if>
			CHG_USER = #{chgUser},
			CHG_DTM = GETDATE(),
		</trim>
		</set>
		WHERE POS_ID = #{posId}
	</update>
	
	<delete id="deletePos" parameterType="HashMap">
		DELETE
		FROM MW_CM_POS_LIST 
		WHERE POS_ID = #{posId} 
	</delete>
</mapper>